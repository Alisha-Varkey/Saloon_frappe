
<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>dpaste: 33SD94M: dont update tree in rename file data patch, by apd</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="icon" type="image/x-icon" href="http://static.dpaste.com.s3.amazonaws.com/favicon.ico">
        <link rel="stylesheet" href="http://static.dpaste.com.s3.amazonaws.com/h5bp/css/normalize.css">
        <link rel="stylesheet" href="http://static.dpaste.com.s3.amazonaws.com/h5bp/css/main.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script src="http://static.dpaste.com.s3.amazonaws.com/h5bp/js/vendor/modernizr-2.8.3.min.js"></script>
        
<script type="text/javascript">
    function key(event, letter) {
        return (event.charCode == letter.charCodeAt() || event.charCode == letter.charCodeAt() + 32)
        }
    function subview_redirect(path_end) {
        location.href = location.href.split('#')[0] + path_end;
        }
    function indicate_wrap() { $("#softwrap_toggle").text("Unwrap"); location.hash = "wrap"; }
    function indicate_unwrap() { $("#softwrap_toggle").text("Soft wrap"); location.hash = ""; }
    function softwrap_toggle() {
        $("pre").toggleClass("softwrap");
        $(".linenodiv").toggle();
        if ($("#softwrap_toggle").text() == "Soft wrap") { indicate_wrap(); }
        else { indicate_unwrap(); }
        }
    function mark_linked_line() {
        $('.linemark').remove();
        $('a[href=#'+location.hash+']').after('<svg height="18" width="24" class="linemark"> <polygon points="3,0 25,9 3,18" style="fill:#33f"></svg>');
        }
    $(document).ready(function() {
        window.onhashchange = mark_linked_line
        $("#softwrap_toggle").click(softwrap_toggle);
        if (location.hash == "#wrap") { softwrap_toggle(); indicate_wrap(); }
        if (location.hash.indexOf("#line-") === 0) { mark_linked_line(); }
        });
    $(document).keypress(function(event){
       if (key(event, 'D')) { subview_redirect('/duplicate/'); }
       if (key(event, 'E')) { subview_redirect('/expiry/'); }
       if (key(event, 'R')) { subview_redirect('.txt'); }
       if (key(event, 'W')) { softwrap_toggle(); }
       if (key(event, 'X')) { subview_redirect('/delete/'); }
        });
</script>

        <link rel="stylesheet" href="http://static.dpaste.com.s3.amazonaws.com/pastebin/css/main.css" type="text/css" media="screen">
        
<style type="text/css">
.highlight .hll { background-color: #ffffcc }
.highlight  { background: #f8f8f8; }
.highlight .c { color: #408080; font-style: italic } /* Comment */
.highlight .err { border: 1px solid #FF0000 } /* Error */
.highlight .k { color: #008000; font-weight: bold } /* Keyword */
.highlight .o { color: #666666 } /* Operator */
.highlight .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #BC7A00 } /* Comment.Preproc */
.highlight .c1 { color: #408080; font-style: italic } /* Comment.Single */
.highlight .cs { color: #408080; font-style: italic } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #FF0000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0044DD } /* Generic.Traceback */
.highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #008000 } /* Keyword.Pseudo */
.highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #B00040 } /* Keyword.Type */
.highlight .m { color: #666666 } /* Literal.Number */
.highlight .s { color: #BA2121 } /* Literal.String */
.highlight .na { color: #7D9029 } /* Name.Attribute */
.highlight .nb { color: #008000 } /* Name.Builtin */
.highlight .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.highlight .no { color: #880000 } /* Name.Constant */
.highlight .nd { color: #AA22FF } /* Name.Decorator */
.highlight .ni { color: #999999; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #0000FF } /* Name.Function */
.highlight .nl { color: #A0A000 } /* Name.Label */
.highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */
.highlight .nv { color: #19177C } /* Name.Variable */
.highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mb { color: #666666 } /* Literal.Number.Bin */
.highlight .mf { color: #666666 } /* Literal.Number.Float */
.highlight .mh { color: #666666 } /* Literal.Number.Hex */
.highlight .mi { color: #666666 } /* Literal.Number.Integer */
.highlight .mo { color: #666666 } /* Literal.Number.Oct */
.highlight .sb { color: #BA2121 } /* Literal.String.Backtick */
.highlight .sc { color: #BA2121 } /* Literal.String.Char */
.highlight .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.highlight .s2 { color: #BA2121 } /* Literal.String.Double */
.highlight .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.highlight .sh { color: #BA2121 } /* Literal.String.Heredoc */
.highlight .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.highlight .sx { color: #008000 } /* Literal.String.Other */
.highlight .sr { color: #BB6688 } /* Literal.String.Regex */
.highlight .s1 { color: #BA2121 } /* Literal.String.Single */
.highlight .ss { color: #19177C } /* Literal.String.Symbol */
.highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */
.highlight .vc { color: #19177C } /* Name.Variable.Class */
.highlight .vg { color: #19177C } /* Name.Variable.Global */
.highlight .vi { color: #19177C } /* Name.Variable.Instance */
.highlight .il { color: #666666 } /* Literal.Number.Integer.Long */
.highlight span:hover { background: #ff9 }
.softwrap { white-space: pre-wrap; }
h1 i { color: #888;}
</style>

    </head>
    <body>
        <!--[if lt IE 8]>
            <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->

        <div id='topbar'>
<h1 style="float: left">
    
		<em>dont update tree in rename file data patch</em>
	
	<i>by apd</i>
</h1>
<div id="headercontrols">
    <a style="float: right; margin: 1em 1em 1em .3em;" class="button-link" href="/" title="Create a new paste">New</a>
    <a style="float: right; margin: 1em .3em;" class="button-link" href="/about" title="Colophon, backstory, stats, tweets">About</a>
    <a style="float: right; margin: 1em .3em;" class="button-link" href="/yours" title="Your last ten pastes, and your preferences">Yours</a>
    <a style="float: right; margin: 1em .3em;" class="button-link" href="/api/v2/" title="Paste creation API">API</a>
    <a style="float: right; margin: 1em .3em;" class="button-link" href="/help" title="Usage tips">Help</a>
</div>

</div>
        <div id='content'>
<div class="controlbar">
    <div class="syntax">1.3Â KB, <strong>Diff</strong></div>
    <div class="controls"> &nbsp;&nbsp;&nbsp;
    <a class="button-link" id="softwrap_toggle" title="Temporarily wrap long lines (shortcut: 'W')">Soft wrap</a>
    <a class="button-link" href="/33SD94M.txt" title="Plaintext version (shortcut: 'R')">Raw text</a>
    <a class="button-link" href="/33SD94M/duplicate/" title="Make a new paste based on this one (shortcut: 'D')">Duplicate</a>
        
    </div>
</div>

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><a href="#line-1"> 1</a>
<a href="#line-2"> 2</a>
<a href="#line-3"> 3</a>
<a href="#line-4"> 4</a>
<a href="#line-5" class="special"> 5</a>
<a href="#line-6"> 6</a>
<a href="#line-7"> 7</a>
<a href="#line-8"> 8</a>
<a href="#line-9"> 9</a>
<a href="#line-10" class="special">10</a>
<a href="#line-11">11</a>
<a href="#line-12">12</a>
<a href="#line-13">13</a>
<a href="#line-14">14</a>
<a href="#line-15" class="special">15</a>
<a href="#line-16">16</a>
<a href="#line-17">17</a>
<a href="#line-18">18</a>
<a href="#line-19">19</a>
<a href="#line-20" class="special">20</a>
<a href="#line-21">21</a>
<a href="#line-22">22</a>
<a href="#line-23">23</a>
<a href="#line-24">24</a>
<a href="#line-25" class="special">25</a>
<a href="#line-26">26</a>
<a href="#line-27">27</a>
<a href="#line-28">28</a>
<a href="#line-29">29</a>
<a href="#line-30" class="special">30</a>
<a href="#line-31">31</a>
<a href="#line-32">32</a>
<a href="#line-33">33</a>
<a href="#line-34">34</a>
<a href="#line-35" class="special">35</a>
<a href="#line-36">36</a>
<a href="#line-37">37</a>
<a href="#line-38">38</a>
<a href="#line-39">39</a></pre></div></td><td class="code"><div class="highlight" style="background: #fff; padding: 0;"><pre><a name="line-1"></a><span class="gh">diff --git a/frappe/core/doctype/file/file.py b/frappe/core/doctype/file/file.py</span>
<a name="line-2"></a><span class="gh">index 04704d8..5be3d64 100644</span>
<a name="line-3"></a><span class="gd">--- a/frappe/core/doctype/file/file.py</span>
<a name="line-4"></a><span class="gi">+++ b/frappe/core/doctype/file/file.py</span>
<a name="line-5"></a><span class="gu">@@ -74,6 +74,10 @@ class File(NestedSet):</span>
<a name="line-6"></a> 
<a name="line-7"></a> 		self.set_folder_size()
<a name="line-8"></a> 
<a name="line-9"></a><span class="gi">+	def on_update(self):</span>
<a name="line-10"></a><span class="gi">+		if not self.flags.dont_update_tree:</span>
<a name="line-11"></a><span class="gi">+			super(File, self).on_update()</span>
<a name="line-12"></a><span class="gi">+</span>
<a name="line-13"></a> 	def set_folder_size(self):
<a name="line-14"></a> 		&quot;&quot;&quot;Set folder size if folder&quot;&quot;&quot;
<a name="line-15"></a> 		if self.is_folder and not self.is_new():
<a name="line-16"></a><span class="gu">@@ -147,7 +151,10 @@ class File(NestedSet):</span>
<a name="line-17"></a> 			frappe.throw(_(&quot;Cannot delete Home and Attachments folders&quot;))
<a name="line-18"></a> 		self.check_folder_is_empty()
<a name="line-19"></a> 		self.check_reference_doc_permission()
<a name="line-20"></a><span class="gd">-		super(File, self).on_trash()</span>
<a name="line-21"></a><span class="gi">+</span>
<a name="line-22"></a><span class="gi">+		if not self.flags.dont_update_tree:</span>
<a name="line-23"></a><span class="gi">+			super(File, self).on_trash()</span>
<a name="line-24"></a><span class="gi">+</span>
<a name="line-25"></a> 		self.delete_file()
<a name="line-26"></a> 
<a name="line-27"></a> 	def make_thumbnail(self):
<a name="line-28"></a><span class="gh">diff --git a/frappe/patches/v6_1/rename_file_data.py b/frappe/patches/v6_1/rename_file_data.py</span>
<a name="line-29"></a><span class="gh">index f077896..b9e7199 100644</span>
<a name="line-30"></a><span class="gd">--- a/frappe/patches/v6_1/rename_file_data.py</span>
<a name="line-31"></a><span class="gi">+++ b/frappe/patches/v6_1/rename_file_data.py</span>
<a name="line-32"></a><span class="gu">@@ -17,6 +17,7 @@ def execute():</span>
<a name="line-33"></a> 		file.flags.ignore_file_validate = True
<a name="line-34"></a> 		file.flags.ignore_duplicate_entry_error = True
<a name="line-35"></a> 		file.flags.ignore_links = True
<a name="line-36"></a><span class="gi">+		file.flags.dont_update_tree = True</span>
<a name="line-37"></a> 		file.set_folder_name()
<a name="line-38"></a> 		try:
<a name="line-39"></a> 			file.save()
</pre></div>
</td></tr></table>
<div class="controlbar">
    Pasted  4Â minutes ago &mdash;
    Expires in <strong>7 days</strong>
    <span class="printonly"><br>URL: http://dpaste.com/33SD94M</span>
</div>
</div>

        <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.11.3.min.js"><\/script>')</script>
        <script src="http://static.dpaste.com.s3.amazonaws.com/h5bp/js/plugins.js"></script>
        <script src="http://static.dpaste.com.s3.amazonaws.com/h5bp/js/main.js"></script>
        <script>
            (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='https://www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-108096-4','auto');ga('send','pageview');
        </script>
    </body>
</html>
